\subsection{Syntax}
\label{sec:syntax}
The full syntax of \langname is presented in \todo.
As we extend the Pirouette language, much of our syntax is identical or similar.
As in Pirouette, we include both choreographic program variables written in uppercase Latin characters ($X,Y,F,\ldots$) and local program variables written in lowercase Latin characters ($x,y,f,\ldots$).
Both choreographic and local type variables, including location variables, are denoted with lowercase Greek characters ($\alpha,\beta,\ldots$).

\todo Explain base choreographic stuff: $\ell.e$, $C_1 \ChorSend[\ell_1] \ell_2$, $\LetIn{\ell.x}{C_1}{C_2}$, $\syncs{\ell_1}{d}{\ell_2}$, $\lambda X \ty \tau.C$, $\mu X \ty \tau.C$

\todo Explain location and type abstraction $\Lambda \alpha \knd \kappa.C$

\todo Explain tell-let binding $\LetTellIn{\alpha}{\ell}{C_1 \knd *_\ell}{\rho}{C_2}$

\paragraph{Location Substitution}
While substitution and variable renaming in \langname can mostly be handled in standard ways, care must be taken to implement \emph{location substitution} correctly.
For instance, consider the following example with a variable location $\alpha$ and concrete location $L$. Note that because $\alpha$ and $L$ are distinct, the local variables $\alpha.x$ and $L.x$ are also distinct.
\begin{mathpar}
\LetIn{\alpha.x \ty \Int}{\alpha.2}{~}\\
\LetIn{L.x \ty \Int}{L.3}{~}\\
\LetIn{\alpha.y}{L.x \ChorSend[L] \alpha}{\alpha.(x + y)}
\end{mathpar}
\ashley{This section may be too detailed? Maybe just define it correctly and show how it works correctly on the example}

Suppose now we want to substitute $L$ in for the variable location $\alpha$ in the program.
One might think that since the location variable $\alpha$ on its own does not clash with any other variables, we may do the substitution na\"ively.
However, in doing so we end up with the following program
\begin{mathpar}
\LetIn{L.x \ty \Int}{L.2}{~}\\
\LetIn{L.x \ty \Int}{L.3}{~}\\
\LetIn{L.y}{L.x \ChorSend[L] L}{L.(x + y)}
\end{mathpar}
which can reduce to $L.6$ because of the capture of $L.x$; clearly not what was intended.
In order to rectify this problem of namespace capture, substitution of locations on local-let expressions is defined as
\begin{mathpar}
\subst{(\LetIn{\ell.x \ty t_e}{C_1}{C_2})}{\alpha}{\ell'} =
  \begin{cases}
    \LetIn{\ell'.y \ty t_e}{\subst{C_1}{\alpha}{\ell'}}{~}\\
    \subst{\subst{C_2}{\ell.x}{\ell.y}}{\alpha}{\ell'} & \ell = \alpha ~\text{and}~ \ell.y, \ell'.y \notin \fv{C_2} \\
    \LetIn{\ell.x \ty t_e}{\subst{C_1}{\alpha}{\ell'}}{~}\\
    \subst{C_2}{\alpha}{\ell'} & \ell \neq \alpha \\
  \end{cases}
\end{mathpar}
where substitution of local variables $\subst{C}{\ell.x}{e}$ is defined in a standard capture-avoiding manner.
The condition that $\ell.y, \ell'.y \notin \fv{C_2}$ in the first clause of the definition is critical, and ensures that no variables are mistakenly captured by the location substitution.

\begin{figure}[h]
  \begin{syntax}
  \abstractCategory[Local Expressions]{e}
  \abstractCategory[Local Variables]{x, y, \ldots}
  \\

  \category[Synchronization Labels]{d}
  \alternative{\Left}
  \alternative{\Right}

  \abstractCategory[Choreographic Variables]{X, Y, \ldots}

  \category[Choreographies]{C, F}
  \alternative{X}
  \alternative{\ell.e}
  \alternative{\Fun{X \ty \tau}{C}}
  \alternative{\Rec{X \ty \tau}{C}}
  \alternative{F~C}\\
  \alternative{C \ChorSend[\ell_1] \ell_2}
  \alternative{\syncs{\ell_1}{d}{\ell_2} \seq C}\\
  \alternative{\ITE{C}{C_1}{C_2}}\\
  \alternative{\TFun{\alpha \knd \kappa}{C}}
  \alternative{C~t}\\
  \alternative{\LetIn{\ell.x \ty t_e}{C_1}{C_2}}\\
  \alternative{\LetTellIn{\alpha}{\ell}{C_1 \knd *_\ell}{\rho}{C_2}}\\
  \alternative{\LetTellIn{\alpha}{\ell}{C_1 \knd *_e}{\rho}{C_2}}
  \end{syntax}

  \caption{Syntax of Choreographies}
  \label{fig:abstract-syntax}
\end{figure}

\begin{figure}[h]
  \begin{syntax}
    \category[Kinds]{\kappa}
    \alternative{*}
    \alternative{*_\ell}
    \alternative{*_s}
    \alternative{*_e}
    \\
    
    \abstractCategory[Type Variables]{\alpha, \beta, \ldots}
    
    \abstractCategory[Local Types]{t_e}

    \categoryFromSet[Locations]{L}{\Locations}
    
    \category[Choreography Types]{t, \ell, \rho, \tau}
    \alternative{\alpha}
    \alternative{t_e @ \ell}
    \alternative{\tau_1 \rightarrow \tau_2}
    \alternative{\forall \alpha \knd \kappa.\tau}
    \\
    \alternative{L}
    \alternative{\varnothing}
    \alternative{\{\ell\}}
    \alternative{\rho_1 \cup \rho_2}
    \\
    \category[Choreography Kinding Contexts]{\Gamma}
    \alternative{\cdot}
    \alternative{\Gamma, \alpha \knd \kappa}
    
    \category[Choreography Typing Contexts]{\Delta}
    \alternative{\cdot}
    \alternative{\Delta, X \ty \tau}
    
    \category[Locally-Bound Typing Contexts]{\Sigma}
    \alternative{\cdot}
    \alternative{\Sigma, \ell.x \ty t_e}
    \\
    \category[Local Kinding Contexts]{\Gamma_e}
    \alternative{\cdot}
    \alternative{\Gamma_e, \alpha}
    
    \category[Local Typing Contexts]{\Sigma_e}
    \alternative{\cdot}
    \alternative{\Sigma_e, x \ty t_e}
  \end{syntax}

  \caption{Syntax of Kinds, Types, and Contexts}
  \label{fig:types}
\end{figure}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "conference"
%%% End:
