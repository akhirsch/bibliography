\subsection{Endpoint Projection}
\label{sec:proj-def}

\begin{mathparpagebreakable}
  \epp{X}{L} = X
  \and
  \epp{\ell.e}{L} =
    \begin{cases}
      \Ret{e} & L = \ell \\
      \CtrlFail & L \neq \ell
  \end{cases}
  \and
  \epp{\Fun{X \ty \tau}{C}}{L} = \CtrlFun{X}{\epp{C}{L}}
  \and
  \epp{\Rec{X \ty \tau}{C}}{L} = \CtrlRec{X}{\epp{C}{L}}
  \and
  \epp{C_1~C_2}{L} = \epp{C_1}{L}~\epp{C_2}{L}
  \and
  \epp{C \ChorSend[\ell_1] \ell_2}{L} =
    \begin{cases}
      \epp{C}{L} & L = \ell_1 = \ell_2 ~\text{or}~ L \neq \ell_1, \ell_2 \\
      \SendTo{\epp{C}{L}}{\ell_2} & L = \ell_1 \neq \ell_2 \\
      \RecvFrom{\ell_1} & L = \ell_2 \neq \ell_1
    \end{cases}
  \and
  \epp{\syncs{\ell_1}{d}{\ell_2} \seq C}{L} =
    \begin{cases}
      \epp{C}{L} & L = \ell_1 = \ell_2 ~\text{or}~ L \neq \ell_1, \ell_2 \\
      \ChooseFor{d}{\ell_2}{\epp{C}{L}} & L = \ell_1 \neq \ell_2 \\
      \AllowChoice{\ell_1}{\epp{C}{L}}{\CtrlNone} & L = \ell_2 \neq \ell_1 ~\text{and}~ d = \Left \\
      \AllowChoice{\ell_1}{\CtrlNone}{\epp{C}{L}} & L = \ell_2 \neq \ell_1 ~\text{and}~ d = \Right
    \end{cases}
  \and
  \epp{\ITE{C}{C_1}{C_2}}{L} =
    \begin{cases}
      \CtrlITE{\epp{C}{L}}{\epp{C_1}{L}}{\epp{C_2}{L}} & L = \ell \\
      \epp{C}{L} \CtrlSeq \epp{C_1}{L} \ctrlmerge \epp{C_2}{L} & L \neq \ell
    \end{cases}
  \and
  \epp{\TFun{\alpha \knd *_\ell}{C}}{L} = \CtrlTFun{\alpha}{\AmI{\alpha}{\epp{\subst{C}{\alpha}{L}}{L}}{\epp{C}{L}}}
  \and
  \epp{\TFun{\alpha \knd \kappa}{C}}{L} = \CtrlTFun{\alpha}{\epp{C}{L}} ~\text{if}~\kappa \neq *_\ell
  \and
  \epp{C~t}{L} = \epp{C}{L}~t
  \and
  \epp{\LetIn{\ell.x \ty t_e}{C_1}{C_2}}{L} =
    \begin{cases}
      \CtrlLetIn{\Ret{x}}{\epp{C_1}{L}}{\epp{C_2}{L}} & L = \ell \\
      \epp{C_1}{L} \CtrlSeq \epp{C_2}{L} & L \neq \ell
    \end{cases}
  \and
  \epp{\LetTellIn{\alpha \knd *_\ell}{\ell}{C_1}{\rho}{C_2}}{L} =
    \begin{cases}
      \begin{array}{@{}l@{}}
        \LetSendIn{\alpha}{\epp{C_1}{L}}{\rho}{~}\\
        ~\AmI{\alpha}{\epp{\subst{C_2}{\alpha}{L}}{L}}{\epp{C_2}{L}}
      \end{array} & L = \ell \\
%      \LetSendIn{\alpha}{\epp{C_1}{L}}{\rho}{\epp{C_2}{L}} & L = \ell ~\text{and}~ L \notin \rho \\
      \begin{array}{@{}l@{}}
      \epp{C_1}{L} \CtrlSeq \LetRecvIn{\alpha}{\ell}{~} \\
      ~\AmI{\alpha}{\epp{\subst{C_2}{\alpha}{L}}{L}}{\epp{C_2}{L}}
      \end{array}
      & L \neq \ell ~\text{and}~ L \in \rho \\
      \epp{C_1}{L} \CtrlSeq \epp{C_2}{L}
        & \begin{array}{@{}l@{}}
            L \neq \ell ~\text{and}~ L \notin \rho \\
            \text{and}~ \alpha \notin \fv(\epp{C_2}{L})
        \end{array}
    \end{cases}
  \and
  \epp{\LetTellIn{\alpha \knd *_e}{\ell}{C_1}{\rho}{C_2}}{L} =
    \begin{cases}
      \LetSendIn{\alpha}{\epp{C_1}{L}}{\rho}{\epp{C_2}{L}} & L = \ell \\
      \epp{C_1}{L} \CtrlSeq \LetRecvIn{\alpha}{\ell}{\epp{C_2}{L}} & L \neq \ell ~\text{and}~ L \in \rho \\
      \epp{C_1}{L} \CtrlSeq \epp{C_2}{L}
        & \begin{array}{@{}l@{}}
            L \neq \ell ~\text{and}~ L \notin \rho \\
            \text{and}~ \alpha \notin \fv(\epp{C_2}{L})
        \end{array}
    \end{cases}
\end{mathparpagebreakable}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "conference"
%%% End:
